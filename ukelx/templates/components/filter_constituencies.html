<script type="text/hyperscript">
    def getSelectedValues(selector)
        set elements to document.querySelectorAll(selector + '.bg-blue-500')
        console.log(elements)
        set values to []
        for el in elements
            set attr to selector.substring(7, selector.length - 1)
            console.log('attr:', attr)
            set value to el.getAttribute(attr)
            if value != '' and value != 'All'
                values.push(value)
            end
        end
        console.log('Selected: ', values)
        return values
    end

    def updateResults()
        set query to #constituency-search.value
        set selectedParties1st to getSelectedValues('button[data-party-1st]')
        set selectedParties2nd to getSelectedValues('button[data-party-2nd]')
        set selectedParties3rd to getSelectedValues('button[data-party-3rd]')
        set selectedRegions to getSelectedValues('button[data-region]')
        set sortButton to document.querySelector('.sort-button.bg-blue-500')
        if sortButton
            set sortBy to sortButton.getAttribute('data-sort')
        else
            set sortBy to 'name'
        end
        set showTop3 to #toggle-candidates.classList.contains('bg-blue-500')
        set partyVoteShare to #party-vote-share.value

        set url to `/constituencies?search=${query}&parties_1st=${selectedParties1st.join(',')}&parties_2nd=${selectedParties2nd.join(',')}&parties_3rd=${selectedParties3rd.join(',')}&regions=${selectedRegions.join(',')}&sort=${sortBy}&top3=${showTop3}&party_vote_share=${partyVoteShare}`
        
        console.log('url:', url)
        fetch `${url}`
            put the result into #constituencies-list.innerHTML
    end

    def filterConstituencies()
        set query to #constituency-search.value.toLowerCase()
        set selectedParties1st to getSelectedValues('button[data-party-1st]')
        set selectedParties2nd to getSelectedValues('button[data-party-2nd]')
        set selectedParties3rd to getSelectedValues('button[data-party-3rd]')
        set selectedRegions to getSelectedValues('button[data-region]')
        set showTop3 to #toggle-candidates.classList.contains('bg-blue-500')
        
        for constituency in #constituencies-list.querySelectorAll('.constituency-card')
            set constituencyName to constituency.querySelector('h2').textContent.toLowerCase()
            set constituencyRegion to constituency.getAttribute('data-region')
            set constituencyPartyElements to constituency.querySelectorAll('[data-party]')
            
            set showConstituency to constituencyName contains query
            
            if showConstituency and selectedParties1st.length > 0
                set showConstituency to selectedParties1st.includes(constituencyPartyElements[0].getAttribute('data-party'))
            end
            
            if showConstituency and selectedParties2nd.length > 0 and constituencyPartyElements.length > 1
                set showConstituency to selectedParties2nd.includes(constituencyPartyElements[1].getAttribute('data-party'))
            end
            
            if showConstituency and selectedParties3rd.length > 0 and constituencyPartyElements.length > 2
                set showConstituency to selectedParties3rd.includes(constituencyPartyElements[2].getAttribute('data-party'))
            end
            
            if showConstituency and selectedRegions.length > 0
                set showConstituency to selectedRegions.includes(constituencyRegion)
            end
            
            if showConstituency
                remove .hidden from constituency
                if showTop3
                    for row in constituency.querySelectorAll('tr')
                        if row.rowIndex > 3
                            add .hidden to row
                        else
                            remove .hidden from row
                        end
                    end
                else
                    for row in constituency.querySelectorAll('tr')
                        remove .hidden from row
                    end
                end
            else
                add .hidden to constituency
            end
        end
    end

    def toggleTopCandidates()
        if #toggle-candidates.classList.contains('bg-blue-500')
            set #toggle-candidates.textContent to 'All candidates'
        else
            set #toggle-candidates.textContent to 'Top 3 candidates'
        end
    end
</script>
